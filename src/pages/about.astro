---
import Layout from "../components/Layout.astro";
import Card from "../components/ui/Card.astro";
import { directus } from "../lib/directus";
import { readItems } from '@directus/sdk';
import { onMount } from 'astro/client';

let aboutArticles = [];
let mainArticle = null;

let feesArticlesHtml = [];
try {
  const response = await directus.request(
    readItems("about", {
      filter: { status: { _eq: "published" } },
      sort: ["id"],
      limit: 10
    })
  );
  aboutArticles = response || [];
  // choose main article: prefer common slugs, otherwise first
  mainArticle = aboutArticles.find(a => ['about-us','about_us','about'].includes(a.slug)) || aboutArticles[0] || null;
  // Preprocess Directus HTML for Membership & Fees
  feesArticlesHtml = aboutArticles
    .filter(a => a.slug === 'membership-fees')
    .map(article => {
      let html = article.content || '';
      html = html.replace(/<table(?![^>]*class=)/g, '<table class="fees-table-classic"');
      html = html.replace(/<table([^>]*class=")([^"]*)"/g, (m, p1, p2) => `<table${p1}fees-table-classic ${p2}"`);
      return html;
    });
} catch (e) {
  console.error("Error fetching about articles:", e);
  aboutArticles = [];
  mainArticle = null;
  feesArticlesHtml = [];
}
---

<style is:global>@import "../styles/tokens.css";</style>

<Layout>
  <div style="max-width:900px;margin:0 auto;padding:0 1.5rem;">
    <section style="padding:3rem 0 2rem 0;">
      <h1 class="egac-section-title">Your Club</h1>
      <p class="egac-section-lead">
        Discover our history, training locations, Academy, and how to join East Grinstead AC.
      </p>
      {mainArticle ? (
        <Card class="card--padded" title={mainArticle.title}>
          <div set:html={mainArticle.content} />
        </Card>
      ) : (
        // fallback: show first about article if none match expected slugs
        aboutArticles.length > 0 ? (
          <Card class="card--padded" title={aboutArticles[0].title}>
            <div set:html={aboutArticles[0].content} />
          </Card>
        ) : (
          <Card class="card--padded" title="About">
            <div>About content is not available.</div>
          </Card>
        )
      )}

      <div class="your-club-tabs">
        <!-- CSS-only radio inputs for tabs (avoids CSP/js issues) -->
        <input type="radio" name="about-tabs" id="tab-radio-locations" class="tab-radio" checked hidden>
        <input type="radio" name="about-tabs" id="tab-radio-academy" class="tab-radio" hidden>
        <input type="radio" name="about-tabs" id="tab-radio-fees" class="tab-radio" hidden>

        <div class="tab-list" role="tablist">
          <label class="tab-btn" for="tab-radio-locations" id="tab-locations" data-tab="locations" role="tab" aria-controls="panel-locations" tabindex="0">Training Locations</label>
          <label class="tab-btn" for="tab-radio-academy" id="tab-academy" data-tab="academy" role="tab" aria-controls="panel-academy" tabindex="-1">Academy</label>
          <label class="tab-btn" for="tab-radio-fees" id="tab-fees" data-tab="fees" role="tab" aria-controls="panel-fees" tabindex="-1">Membership & Fees</label>
        </div>
        <div class="tab-panels">
          <div class="tab-panel" id="panel-locations" role="tabpanel" aria-labelledby="tab-locations">
            <div class="tab-content-box">
              <h2 class="tab-section-title">Training Locations</h2>
              <div class="locations-grid">
                <div class="location-card">
                  <div class="location-info">
                    <div class="location-name">Imberhorne Ln</div>
                    <a href="https://maps.google.com/?q=Imberhorne+Ln,+East+Grinstead+RH19+1QY" target="_blank" rel="noopener" class="location-link">East Grinstead RH19 1QY</a>
                  </div>
                  <div class="location-map-wrap">
                    <iframe class="location-map" src="https://www.google.com/maps?q=Imberhorne+School,+East+Grinstead+RH19+1QY&output=embed" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                  </div>
                </div>
                <div class="location-card">
                  <div class="location-info">
                    <div class="location-name">Lewes Rd</div>
                    <a href="https://maps.google.com/?q=Lewes+Rd,+East+Grinstead+RH19+3TY" target="_blank" rel="noopener" class="location-link">East Grinstead RH19 3TY</a>
                  </div>
                  <div class="location-map-wrap">
                    <iframe class="location-map" src="https://www.google.com/maps?q=Sackville+School,+East+Grinstead+RH19+3TY&output=embed" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-panel" id="panel-academy" role="tabpanel" aria-labelledby="tab-academy">
            <div class="tab-content-box">
              <h2 class="tab-section-title">Academy</h2>
              {aboutArticles.filter(a => a.slug === 'academy').map(article => (
                <div set:html={article.content} />
              ))}
            </div>
          </div>
          <div class="tab-panel" id="panel-fees" role="tabpanel" aria-labelledby="tab-fees">
            <div class="tab-content-box">
              <h2 class="tab-section-title">Membership & Fees</h2>
              <div class="fees-table-wrap">
                  {feesArticlesHtml.map(html => <div set:html={html} />)}
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        (function() {
          const tabs = ['locations', 'academy', 'fees'];
          function styleFeesTables() {
            const panel = document.getElementById('panel-fees');
            if (!panel) return;
            const tables = panel.querySelectorAll('table');
            tables.forEach(t => t.classList.add('fees-table-classic'));
          }
          function setTabState(active) {
            tabs.forEach(t => {
              const btn = document.getElementById('tab-' + t);
              const panel = document.getElementById('panel-' + t);
              const radio = document.getElementById('tab-radio-' + t);
              if (!btn || !panel || !radio) return;
              btn.setAttribute('aria-selected', t === active ? 'true' : 'false');
              btn.setAttribute('tabindex', t === active ? '0' : '-1');
              panel.hidden = t !== active;
              radio.checked = t === active;
            });
            if (active === 'fees') styleFeesTables();
          }
          function init() {
            const buttons = Array.from(document.querySelectorAll('.tab-btn[data-tab]'));
            buttons.forEach(btn => {
              btn.addEventListener('click', () => setTabState(btn.dataset.tab));
              btn.addEventListener('keydown', (e) => {
                const idx = buttons.indexOf(btn);
                if (e.key === 'ArrowRight') {
                  const next = buttons[(idx + 1) % buttons.length];
                  next.focus();
                  setTabState(next.dataset.tab);
                  e.preventDefault();
                } else if (e.key === 'ArrowLeft') {
                  const prev = buttons[(idx - 1 + buttons.length) % buttons.length];
                  prev.focus();
                  setTabState(prev.dataset.tab);
                  e.preventDefault();
                } else if (e.key === 'Enter' || e.key === ' ') {
                  setTabState(btn.dataset.tab);
                  e.preventDefault();
                }
              });
            });
            setTabState('locations');
            // Style tables if fees tab is default (for direct navigation)
            if (document.getElementById('tab-radio-fees').checked) styleFeesTables();
          }
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
          } else {
            init();
          }
        })();
      </script>

    </section>
  </div>
  <style>
    .your-club-tabs {
      margin-top: 2.5rem;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .tab-list {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .tab-btn {
      display: inline-block;
      background: #f3f6fb;
      color: var(--blue);
      font-family: var(--font-heading);
      font-size: 1.05rem;
      font-weight: 800;
      border-radius: 0.6rem;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: color 0.18s, background 0.18s, transform 0.12s;
      outline: none;
      margin-bottom: -2px;
    }
    .tab-btn:hover { transform: translateY(-2px); }
    .tab-btn[aria-selected="true"] {
      color: var(--yellow);
      background: none;
      border-bottom: 3px solid var(--yellow);
      box-shadow: none;
      z-index: 2;
    }
    .tab-btn:focus-visible {
      box-shadow: 0 2px 0 0 var(--yellow);
    }
    .tab-panels {
      background: none;
    }
    .tab-panel {
      padding: 2rem 0 0 0;
      animation: fadeInTab 0.3s;
      display: none;
    }

    /* Show panels when corresponding radio is checked */
    #tab-radio-locations:checked ~ .tab-list + .tab-panels #panel-locations,
    #tab-radio-academy:checked ~ .tab-list + .tab-panels #panel-academy,
    #tab-radio-fees:checked ~ .tab-list + .tab-panels #panel-fees {
      display: block;
    }

    /* Visual state for selected tabs */
    #tab-radio-locations:checked ~ .tab-list label[for="tab-radio-locations"],
    #tab-radio-academy:checked ~ .tab-list label[for="tab-radio-academy"],
    #tab-radio-fees:checked ~ .tab-list label[for="tab-radio-fees"] {
      color: var(--yellow);
      border-bottom: 3px solid var(--yellow);
    }
    .tab-section-title {
      font-size: 1.4rem;
      font-family: var(--font-heading);
      color: var(--blue);
      margin-bottom: 1rem;
      text-align: left;
    }
    .tab-list-info {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .tab-content-box {
      background: #f8fafc;
      border-radius: 1.2rem;
      box-shadow: 0 2px 12px rgba(20,95,186,0.06);
      padding: 2rem 1.5rem;
      margin-bottom: 2rem;
    }
    .locations-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
      margin-top: 1.2rem;
    }
    @media (min-width: 700px) {
      .locations-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    .location-card {
      display: flex;
      flex-direction: column;
      background: #f4f8fd;
      border-radius: 1rem;
      box-shadow: 0 1px 4px rgba(20,95,186,0.06);
      padding: 1.2rem 1.5rem;
      min-width: 0;
      flex: 1 1 0;
      align-items: flex-start;
      gap: 1.2rem;
    }
    .location-info {
      min-width: 0;
    }
    .location-name {
      font-family: var(--font-heading);
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--blue);
      margin-bottom: 0.2rem;
    }
    .location-link {
      color: var(--blue);
      text-decoration: underline;
      font-size: 1rem;
      transition: color 0.18s;
      word-break: break-all;
    }
    .location-link:hover, .location-link:focus {
      color: var(--yellow);
    }
    .location-map-wrap {
      width: 100%;
      border-radius: 0.7rem;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(20,95,186,0.10);
      margin-top: 0.5rem;
    }
    .location-map {
      width: 100%;
      height: 200px;
      border: 0;
      display: block;
    }
    .fees-table-wrap {
      width: 100%;
      margin-bottom: 1rem;
      overflow-x: auto;
    }
    .fees-table-classic {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 0.7rem;
      overflow: hidden;
      font-size: 1rem;
      box-shadow: 0 1px 4px rgba(20,95,186,0.06);
      border: 1px solid #e0e0e0;
    }
    .fees-table-classic th, .fees-table-classic td {
      text-align: center;
      padding: 0.8rem 0.7rem;
      border-bottom: 1px solid #e0e0e0;
    }
    .fees-table-classic th {
      background: var(--blue);
      color: var(--white);
      font-weight: 700;
    }
    .fees-table-classic tr:last-child td {
      border-bottom: none;
    }
    @keyframes fadeInTab {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Membership fees table: style content coming from Directus */
    .tab-panel#panel-fees .tab-content-box figure.wp-block-table,
    .tab-panel#panel-fees .tab-content-box table {
      width: 100%;
      margin: 0 0 1rem 0;
      overflow: hidden;
      border-radius: 0.7rem;
      box-shadow: 0 6px 18px rgba(20,95,186,0.06);
      border: 1px solid #e6eef8;
      background: white;
    }

    .tab-panel#panel-fees .tab-content-box table {
      border-collapse: collapse;
      font-size: 1rem;
      width: 100%;
    }

    .tab-panel#panel-fees .tab-content-box th,
    .tab-panel#panel-fees .tab-content-box td {
      padding: 0.85rem 1rem;
      text-align: center;
      border-bottom: 1px solid #eef6fb;
      color: var(--dark-gray);
    }

    .tab-panel#panel-fees .tab-content-box th {
      background: var(--blue);
      color: #fff;
      font-weight: 700;
    }

    .tab-panel#panel-fees .tab-content-box tr:nth-child(even) {
      background: #fbfdff;
    }

    .tab-panel#panel-fees .tab-content-box tr:last-child td { border-bottom: none; }

    .tab-panel#panel-fees .tab-content-box p { margin-bottom: 0.9rem; line-height: 1.6; color: var(--dark-gray); }
    .tab-panel#panel-fees .tab-content-box a { color: var(--blue); text-decoration: underline; }

    @media (max-width: 700px) {
      .tab-panel#panel-fees .tab-content-box th,
      .tab-panel#panel-fees .tab-content-box td { padding: 0.6rem 0.5rem; font-size: 0.95rem; }
      .tab-panel#panel-fees .tab-content-box table { display: block; overflow-x: auto; }
    }
  </style>
  <style>
    .egac-section-title {
      font-size: 3rem;
      font-weight: 900;
      color: var(--blue);
      margin-bottom: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      text-align: center;
      font-family: var(--font-heading);
      text-shadow: 0 2px 12px rgba(20, 95, 186, 0.08);
    }
    .egac-section-lead {
      color: var(--dark-gray);
      margin-bottom: 2.5rem;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      font-family: var(--font-sans);
    }
  </style>
</Layout>
