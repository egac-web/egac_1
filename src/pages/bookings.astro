---
// This page is NOT linked from the main site navigation. Share the URL directly with those who need access.
import Layout from "../components/Layout.astro";
import TrainingBookingSystem from "../components/TrainingBookingSystem";
import "../styles/bookings.css";
import { getNextNWeekdayDates, CONFIG } from "../lib/booking";

// Build a simple server-rendered set of slots so the page shows cards immediately.
const dates = getNextNWeekdayDates(2, 6); // next 6 weeks
const slots = dates.flatMap((date) => [
  { id: `${date}-u13-1`, date, group: 'u13' },
  { id: `${date}-u15-1`, date, group: 'u15plus' },
]);

// If an invite token is present in the URL, fetch server-side invite data from the booking API
let inviteToken = null;
let inviteData = null;
let inviteBanner = null;
try {
  const url = new URL(Astro.request.url);
  inviteToken = url.searchParams.get('invite');
  if (inviteToken) {
    const apiUrl = new URL(`/api/booking.json?invite=${encodeURIComponent(inviteToken)}`, url.origin).toString();
    const res = await fetch(apiUrl);
    if (res.ok) {
      const body = await res.json();
      if (body && body.ok) {
        inviteData = body;
        // find a first eligible slot with vacancies
        const firstAvail = (inviteData.availability || []).find((a) => a.eligibleSlot && a.slots && (a.slots[a.eligibleSlot] > 0));
        if (firstAvail) inviteBanner = { eligibleSlot: firstAvail.eligibleSlot, date: firstAvail.date };
      }
    }
  }
} catch (err) {
  // Non-fatal: page still works if we fail to fetch invite data
  console.error('Failed to fetch invite data', err);
}

// Fetch availability for public (non-invite) view so we can hide full sessions
let pageAvailability = null;
if (!inviteToken) {
  try {
    const apiUrl = new URL(`/api/booking.json`, new URL(Astro.request.url).origin).toString();
    const r = await fetch(apiUrl);
    if (r.ok) {
      const body = await r.json();
      if (body && body.ok) pageAvailability = body.availability;
    }
  } catch (e) { console.error('Failed to fetch availability for public bookings page', e); }
}
---

<Layout title="Training Session Bookings">

    {inviteData ? (
      <div class="invite-banner">
        <div style="flex:1;">
          <div class="meta">Invited: {inviteData.enquiry.name || inviteData.enquiry.email}</div>
          {inviteBanner ? (
            <div class="hint">You're eligible for <strong>{CONFIG.slots[inviteBanner.eligibleSlot].label}</strong> on <strong>{new Date(inviteBanner.date).toLocaleDateString('en-GB')}</strong>. Use the <em>Book (invited)</em> button to reserve your spot — it's held for you for a limited time.</div>
          ) : inviteData.booking ? (
            <div class="hint">You already have a booking on {inviteData.booking.session_date} — check your email for confirmation.</div>
          ) : (
            <div class="hint">We couldn't find an eligible slot with vacancies; check other dates or contact us.</div>
          )}
        </div>
        <div style="text-align:right;">
          <a class="btn-primary" href={`/bookings?invite=${inviteData.invite.token}`}>View available sessions</a>
        </div>
      </div>
    ) : null}

    <div>
      <TrainingBookingSystem client:load inviteToken={inviteToken} />
    </div>

