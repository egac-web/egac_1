---
interface Props {
  webhookUrl?: string;
  title?: string;
  showCard?: boolean;
  defaultArea?: string;
}
const {
  webhookUrl = "https://hook.make.com/your-make-webhook-id-here",
  title = "Send an enquiry",
  showCard = true,
  defaultArea = "",
} = Astro.props;
import Card from "../ui/Card.astro";
import "../../styles/forms.css";
---

{showCard ? (
  <Card class="card--padded" title={title}>
    <form id="enquiry-form" class="space-y-6 egac-form" x-data="enquiryForm()" x-init="(() => {
            // Prefill from data-default-area prop or URL query param (query param wins)
            const d = $el.dataset.defaultArea || '';
            const params = typeof location !== 'undefined' ? new URLSearchParams(location.search) : null;
            const q = params ? params.get('area_of_interest') : null;
            const area = q || d;
            if (area) {
              const sel = $el.querySelector('[name=area_of_interest]');
              if (sel) sel.value = area;
            }
          })()" @submit.prevent="submitForm" aria-live="polite" data-webhook-url={webhookUrl} data-default-area={defaultArea}>
      <div x-show="success" class="p-4 mb-4 bg-green-50 border border-green-200 text-green-800 rounded" x-cloak>
        <strong>Thanks —</strong> Your enquiry has been received. We’ll get back to you within 24 hours.
      </div>
      <div x-show="error" class="p-3 mb-4 bg-red-50 border border-red-200 text-red-800 rounded" x-text="error" x-cloak></div>

      <div>
        <label class="block text-sm font-medium mb-2">Is this enquiry for…</label>
        <div class="flex gap-6">
          <label class="inline-flex items-center gap-2"><input type="radio" name="enquiry_for" value="myself" x-model="form.enquiry_for" required class="h-4 w-4" /> <span class="text-sm">Myself (adult athlete, coach, volunteer)</span></label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="enquiry_for" value="child" x-model="form.enquiry_for" required class="h-4 w-4" /> <span class="text-sm">My child / someone else</span></label>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-2">Full name</label>
          <input name="contact_name" placeholder="Your full name" required class="w-full border border-gray-200 rounded-md p-3 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
          <div x-show="errors.contact_name" class="form-field-error" x-text="errors.contact_name"></div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Email</label>
          <input type="email" name="contact_email" placeholder="Your email" required class="w-full border border-gray-200 rounded-md p-3 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
          <div x-show="errors.contact_email" class="form-field-error" x-text="errors.contact_email"></div>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-2">Phone (optional)</label>
          <input type="tel" name="contact_phone" placeholder="Your phone (optional)" class="w-full border border-gray-200 rounded-md p-3 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium mb-2">Area of interest</label>
        <select name="area_of_interest" required class="w-full border border-gray-200 rounded-md p-3 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-300">
          <option value="">Select…</option>
        </select>
        <div x-show="errors.area_of_interest" class="form-field-error" x-text="errors.area_of_interest"></div>
          <option value="Training">Training</option>
          <option value="Coaching">Coaching</option>
          <option value="Officiating">Officiating</option>
          <option value="Helping out">Helping out</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-2">Message</label>
        <textarea name="message" rows="6" placeholder="How can we help?" required class="w-full border border-gray-200 rounded-md p-3 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-300 resize-vertical"></textarea>
        <div x-show="errors.message" class="form-field-error" x-text="errors.message"></div>
      </div>

      <div class="flex items-start gap-3">
        <label class="inline-flex items-center gap-3 text-sm"><input type="checkbox" name="gdpr_consent" required class="h-4 w-4" /> <span>I consent to EGAC storing and processing my data for club purposes. See <a href="/policies/privacy" class="text-blue-700 underline">Privacy Policy</a>.</span></label>
      </div>
      <div x-show="errors.gdpr_consent" class="form-field-error" x-text="errors.gdpr_consent"></div>

      <div style="display:none;">
        <label>Leave this field blank</label>
        <input type="text" name="honeypot" tabindex="-1" autocomplete="off" />
      </div>

      <div class="pt-3">
        <button type="submit" class="btn btn-cta" :disabled="submitting" :class="{ 'opacity-50 cursor-not-allowed': submitting }" x-text="submitting ? 'Sending…' : 'Send Enquiry'"></button>
      </div>
    </form>
  </Card>
) : (
  <form id="enquiry-form" class="space-y-6" x-data="enquiryForm()" @submit.prevent="submitForm" aria-live="polite" data-webhook-url={webhookUrl}>
    <div x-show="success" class="p-4 mb-4 bg-green-50 border border-green-200 text-green-800 rounded" x-cloak>
      <strong>Thanks —</strong> Your enquiry has been received. We’ll get back to you within 24 hours.
    </div>
    <div x-show="error" class="p-3 mb-4 bg-red-50 border border-red-200 text-red-800 rounded" x-text="error" x-cloak></div>

    <div>
      <label class="block text-sm font-medium mb-2">Is this enquiry for…</label>
      <div class="flex gap-6">
        <label class="inline-flex items-center gap-2"><input type="radio" name="enquiry_for" value="myself" x-model="form.enquiry_for" required class="h-4 w-4" /> <span class="text-sm">Myself (adult athlete, coach, volunteer)</span></label>
        <label class="inline-flex items-center gap-2"><input type="radio" name="enquiry_for" value="child" x-model="form.enquiry_for" required class="h-4 w-4" /> <span class="text-sm">My child / someone else</span></label>
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-2">Full name</label>
        <input name="contact_name" placeholder="Your full name" required class="w-full border border-gray-200 rounded-md p-3 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">Email</label>
        <input type="email" name="contact_email" placeholder="Your email" required class="w-full border border-gray-200 rounded-md p-3 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-2">Phone (optional)</label>
        <input type="tel" name="contact_phone" placeholder="Your phone (optional)" class="w-full border border-gray-200 rounded-md p-3 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-300" />
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium mb-2">Area of interest</label>
      <select name="area_of_interest" required class="w-full border border-gray-200 rounded-md p-3 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-300">
        <option value="">Select…</option>
        <option value="Training">Training</option>
        <option value="Coaching">Coaching</option>
        <option value="Officiating">Officiating</option>
        <option value="Helping out">Helping out</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium mb-2">Message</label>
      <textarea name="message" rows="6" placeholder="How can we help?" required class="w-full border border-gray-200 rounded-md p-3 text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-300 resize-vertical"></textarea>
    </div>

    <div class="flex items-start gap-3">
      <label class="inline-flex items-center gap-3 text-sm"><input type="checkbox" name="gdpr_consent" required class="h-4 w-4" /> <span>I consent to EGAC storing and processing my data for club purposes. See <a href="/policies/privacy" class="text-blue-700 underline">Privacy Policy</a>.</span></label>
    </div>

    <div style="display:none;">
      <label>Leave this field blank</label>
      <input type="text" name="honeypot" tabindex="-1" autocomplete="off" />
    </div>

    <div class="pt-3">
      <button type="submit" class="btn btn-cta" :disabled="submitting" :class="{ 'opacity-50 cursor-not-allowed': submitting }" x-text="submitting ? 'Sending…' : 'Send Enquiry'"></button>
    </div>
  </form>
)}

<script>
  function enquiryForm() {
    return {
      form: { enquiry_for: 'myself' },
      submitting: false,
      success: false,
      error: '',
      errors: {},

      validate() {
        this.errors = {};
        const el = document.getElementById('enquiry-form');
        const values = Object.fromEntries(new FormData(el));
        if (!values.contact_name || !values.contact_name.trim()) this.errors.contact_name = 'Please enter your name.';
        if (!values.contact_email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(values.contact_email)) this.errors.contact_email = 'Please enter a valid email address.';
        if (!values.message || !values.message.trim()) this.errors.message = 'Please add a short message.';
        if (!values.area_of_interest) this.errors.area_of_interest = 'Please select an area of interest.';
        if (!(values.gdpr_consent === 'on' || values.gdpr_consent === true || values.gdpr_consent === 'true')) this.errors.gdpr_consent = 'You must consent to data processing.';
        return Object.keys(this.errors).length === 0;
      },

      async submitForm(e) {
        this.submitting = true;
        this.error = '';
        this.success = false;

        try {
          if (!this.validate()) {
            this.error = 'Please fix the highlighted errors.';
            this.submitting = false;
            return;
          }

          const formEl = e.target;
          const webhook = formEl.dataset.webhookUrl || "https://hook.make.com/your-make-webhook-id-here";
          const formData = new FormData(formEl);
          const data = Object.fromEntries(formData);

          // Honeypot check
          if (data.honeypot) {
            this.error = 'Spam detected.';
            this.submitting = false;
            return;
          }

          const res = await fetch(webhook, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (!res.ok) {
            const json = await res.json().catch(() => null);
            throw new Error((json && json.error) ? json.error : 'Submission failed.');
          }

          this.success = true;
          formEl.reset();
          this.form.enquiry_for = 'myself';
        } catch (err) {
          this.error = err.message || 'Something went wrong — please try again later.';
        } finally {
          this.submitting = false;
        }
      }
    };
  }
</script>

<style>
  /* Enquiry form local styles to match EGAC look-and-feel */
  #enquiry-form {
    font-family: var(--font-sans);
    color: var(--dark-gray);
  }

  #enquiry-form label {
    color: var(--dark-gray);
    font-weight: 700;
  }

  #enquiry-form input[type="text"],
  #enquiry-form input[type="email"],
  #enquiry-form input[type="tel"],
  #enquiry-form select,
  #enquiry-form textarea {
    background: var(--muted-2);
    border: 1px solid rgba(20,95,186,0.08);
    color: var(--dark-gray);
  }

  #enquiry-form input[type="text"]::placeholder,
  #enquiry-form input[type="email"]::placeholder,
  #enquiry-form input[type="tel"]::placeholder,
  #enquiry-form textarea::placeholder {
    color: #9aa4b2;
  }

  #enquiry-form input:focus,
  #enquiry-form select:focus,
  #enquiry-form textarea:focus {
    outline: none;
    border-color: var(--yellow);
    box-shadow: 0 6px 18px rgba(253,185,19,0.12);
    background: var(--muted-3);
  }

  .radio-group label, .checkbox-group label, #enquiry-form .inline-flex {
    font-weight: 600;
    color: var(--dark-gray);
  }

  /* Success & error banners should align with card style */
  #enquiry-form [x-show="success"] {
    background: rgba(220, 255, 235, 0.9);
    border: 1px solid rgba(34, 197, 94, 0.12);
  }
  #enquiry-form [x-show="error"] {
    background: rgba(255, 235, 238, 0.95);
    border: 1px solid rgba(239, 68, 68, 0.12);
  }

  /* Ensure spacing inside Card aligns with other cards */
  .card--padded #enquiry-form { padding: 0; }

  @media (max-width: 800px) {
    #enquiry-form .grid { grid-template-columns: 1fr; }
  }
</style>