document.getElementById("login").addEventListener("click",async()=>{const l=document.getElementById("admintoken").value;document.getElementById("status").textContent="Loading…";try{const u=await(await fetch("/api/admin/enquiries.json",{headers:{"x-admin-token":l}})).json();if(!u.ok){document.getElementById("status").textContent="Error: "+(u.error||"Unauthorized");return}document.getElementById("status").textContent="";const p=document.getElementById("data");p.innerHTML="",u.enquiries.forEach(t=>{const s=document.createElement("div");s.className="card card--padded",s.innerHTML=`<h3>${t.name||t.email||"No name"}</h3>
        <p><strong>Email:</strong> ${t.email||""}</p>
        <p><strong>Note:</strong> ${t.note||""}</p>
        <p><strong>Events:</strong> ${JSON.stringify(t.events||[])}</p>
        <p><strong>Invite:</strong> ${t.invites&&t.invites.length?t.invites[0].token:"none"}</p>
        <div>
          <label>Presli note: <input data-enquiry-id="${t.id}" class="presli-note" type="text" placeholder="Optional note" /></label>
          <button class="presli-confirm" data-enquiry-id="${t.id}">Confirm Presli attendance & send membership link</button>
          <div class="presli-result" data-enquiry-id="${t.id}" style="margin-top:0.5rem"></div>
        </div>
        <div class="bookings"><strong>Bookings:</strong></div>`;const r=document.createElement("div"),d=s.querySelector(".presli-confirm"),n=s.querySelector(".presli-note");d&&d.addEventListener("click",async e=>{const i=d.dataset.enquiryId,g=n?n.value:"",a=s.querySelector(".presli-result");a.textContent="Processing…";try{const m=await fetch("/api/admin/enquiry/presli_confirm.json",{method:"POST",headers:{"Content-Type":"application/json","x-admin-token":l},body:JSON.stringify({enquiry_id:i,note:g,send_membership_link:!0})}),o=await m.json();if(!o.ok&&m.status!==200){a.textContent="Error: "+(o.error||"Unauthorized");return}const c=[];o.membership_sent&&c.push("<div>Membership link sent</div>"),o.membership_error&&c.push(`<div style="color:darkred">${o.membership_error}</div>`),o.event&&c.push(`<div>Event recorded: ${o.event.type}</div>`),a.innerHTML=c.join("")}catch{a.textContent="Server error"}}),r.className="booking-list",t.bookings&&t.bookings.length?t.bookings.forEach(e=>{const i=document.createElement("div");i.className="booking-item",i.dataset.bookingId=e.id;const g=e.status||"scheduled";i.innerHTML=`<div><strong>${e.session_date} ${e.slot} (${g})</strong></div><div>${e.session_time||""}</div>`;const a=document.createElement("div");a.style.marginTop="0.5rem";const m=document.createElement("button");m.textContent="Mark attended",m.addEventListener("click",()=>k(l,e.id,"attended"));const o=document.createElement("button");o.textContent="Mark no-show",o.style.marginLeft="0.5rem",o.addEventListener("click",()=>k(l,e.id,"no_show"));const c=document.createElement("label");c.style.marginLeft="0.5rem",c.innerHTML=`<input type="checkbox" data-booking-id="${e.id}" /> Send membership link`;const v=document.createElement("button");v.style.marginLeft="0.5rem",v.textContent="Get coach message",v.addEventListener("click",()=>k(l,e.id,g,!1,!0)),a.appendChild(m),a.appendChild(o),a.appendChild(c),a.appendChild(v),i.appendChild(a);const y=document.createElement("div");y.className="booking-result",y.style.marginTop="0.5rem",i.appendChild(y),r.appendChild(i)}):r.textContent="none",s.appendChild(r),p.appendChild(s)})}catch{document.getElementById("status").textContent="Server error"}});async function k(l,h,u,p=null,t=!1){const s=document.querySelector(`.booking-item[data-booking-id="${h}"]`),r=s&&s.querySelector(".booking-result");if(r){if(r.textContent="Processing…",p===null){const d=s.querySelector('input[type="checkbox"]');p=d?d.checked:!1}try{const d=await fetch("/api/admin/booking/attendance.json",{method:"POST",headers:{"Content-Type":"application/json","x-admin-token":l},body:JSON.stringify({booking_id:h,status:u==="no_show"?"no_show":"attended",send_membership_link:p})}),n=await d.json();if(!n.ok&&d.status!==200){r.textContent="Error: "+(n.error||"Unauthorized");return}const e=[];n.coachMessage&&e.push(`<div><strong>Coach message:</strong> <pre style="white-space:pre-wrap;">${n.coachMessage}</pre><button class="copy-btn">Copy</button></div>`),n.presliCSV&&e.push(`<div><strong>Presli CSV row:</strong> <code>${n.presliCSV}</code></div>`),n.membership_sent!==void 0&&e.push(`<div><strong>Membership email sent:</strong> ${n.membership_sent}</div>`),n.membership_error&&e.push(`<div style="color:darkred"><strong>Membership error:</strong> ${n.membership_error}</div>`),r.innerHTML=e.join("");const i=r.querySelector(".copy-btn");i&&i.addEventListener("click",()=>navigator.clipboard.writeText(n.coachMessage||""))}catch{r.textContent="Server error"}}}
