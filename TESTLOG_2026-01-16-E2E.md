# TESTLOG ADDENDUM — 2026-01-16 E2E Dry-run (local runner)

**Context:** Attempted a local E2E dry-run from the workspace runner to exercise invite → send (dry-run) → booking → reminder flow. The runner is missing Supabase credentials and therefore could not perform DB inserts or call send endpoints that require service keys.

## Actions attempted

1. Create a test invite
   - Command: `cd egac_1 && node scripts/create_test_invite.mjs`
   - Result: **Failed** — `Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in environment` (script exited with code 2). The script requires a Supabase service role key for test inserts.

2. Run a dry-run invite send
   - Command: `RESEND_DRY_RUN=1 node egac_1/scripts/send_invite_really.mjs --yes`
   - Result: **Skipped** (invite creation failed and this script also requires `RESEND_API_KEY` / `RESEND_FROM` to be set if not in dry-run short-circuit mode).

3. Test booking POST handler locally
   - Command: `node scripts/test_booking_post.mjs` (imports the booking POST handler and executes it)
   - Result: **Not run** — the handler uses Supabase and will fail without `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY`.

4. Trigger reminders endpoint (planned)
   - Command: `curl -sS "https://staging.eastgrinsteadac.co.uk/api/admin/send-reminders.json?secret=$CRON_SECRET&dry_run=1"`
   - Result: **Not executed** — requires a booking in the database and a valid `CRON_SECRET`.

## Analysis
- The workspace runner lacks required secrets (Supabase service role and Resend keys) to perform E2E inserts and sends.
- These tests should be run from a secure environment (local dev machine or CI job) that has the secrets available as environment variables or repository secrets.

## Recommended commands to run locally or in CI (example)

```bash
# 1) Create a test invite (staging DB, service role key required)
SUPABASE_URL="<your-staging-supabase-url>" SUPABASE_SERVICE_ROLE_KEY="<service-role-key>" RESEND_DRY_RUN=1 node egac_1/scripts/create_test_invite.mjs

# 2) Send the invite (dry-run guard on by default)
RESEND_DRY_RUN=1 node egac_1/scripts/send_invite_really.mjs --yes

# 3) Create a booking for that invite (use the invite id from step 1)
SUPABASE_URL="<your-staging-supabase-url>" SUPABASE_SERVICE_ROLE_KEY="<service-role-key>" node egac_1/scripts/create_test_booking.mjs --invite-id <id> --date "2026-01-17"

# 4) Trigger reminders endpoint in dry-run
curl -sS "https://staging.eastgrinsteadac.co.uk/api/admin/send-reminders.json?secret=$CRON_SECRET&dry_run=1"
```

## Next steps
- If you'd like, I can:
  - Prepare a GitHub Actions workflow that runs the E2E dry-run with secrets stored in Actions secrets (I will add steps to redact outputs and only record IDs and event summaries in `TESTLOG.md`).
  - Or, you can run the commands locally and paste the outputs (invite id, booking id, Resend dry-run ids) and I will append them to `egac_1/TESTLOG.md` and `egac_1/CHANGELOG.md` as verification evidence.

### New: Cloudflare-side E2E runner
We added a protected admin endpoint to run the full E2E dry-run from the Cloudflare Pages environment where staging secrets live.

- URL: `POST https://staging.eastgrinsteadac.co.uk/api/admin/run-e2e.json`
- Auth: Header `x-admin-token: <ADMIN_TOKEN>` or query `?token=dev` (dev token accepted for convenience)
- Required body: `{ "confirm": "yes" }` (string) to prevent accidental runs
- Optional body: `{ "dry_run": true }` (default: true) — the endpoint respects `RESEND_DRY_RUN` semantics and will send dry-run notifications (no real emails) in staging.

Example curl (dry-run, safe):
```bash
curl -sS -X POST "https://staging.eastgrinsteadac.co.uk/api/admin/run-e2e.json?token=dev" \
  -H "Content-Type: application/json" \
  -d '{"confirm":"yes","dry_run":true}'
```

- Output: JSON with sanitized summary: `enquiry.id`, `invite.id`, `booking.id`, and `steps` array containing send results. The endpoint appends an `e2e_test_completed` event to the created enquiry with step results so you can inspect the flow via the admin UI.

**Security note:** This endpoint runs with the runtime secrets available to Pages/Workers and should only be called against staging. For production runs, ensure `confirm=yes` is intentionally provided and consider restricting further via IP or a dedicated run token.

---

*Logged by GitHub Copilot*